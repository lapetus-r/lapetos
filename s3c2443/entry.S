/*
朱收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收朱
早			  														  lapetOS			   													   早
早				 						 [ General Purpose Kernel for Embedded System ]									   早
早			  																   																	   早
早			  							  					SangMyung University									   					   早
早			  							  				  Computer Science Major												       早
早			  																				   													   早
早					  					  Made by: Yoo Sang-Gi / Park Il-Kwon, 2011-2012							  	   早
早			  											 	   File Name: entry.S		 												   早
朱收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收朱
*/

#define svc_stack	0x30300000				/* SVC 賅萄 蝶鷗 廓雖							*/
#define irq_stack	0x30380000				/* IRQ 賅萄 蝶鷗 廓雖								*/

.global	_ram_entry
.global	kernel_init
.global	kernel_soft_CS
.global	kernel_hard_CS
.global	kernel_tick
.global	kernel_entry
.global	kernel_enable_int
.global	kernel_disable_int

/*
朱收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收朱
早				 													 [ Ram Entry ]															   早
朱收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收朱
*/

_ram_entry:											/* 極 縛お葬: 睡お煎渦縑憮 輿模蒂 霤褻	*/

	b		kernel_init
	b		_ram_entry
	b		kernel_soft_CS
	b		kernel_tick
	b		kernel_hard_CS
	b		kernel_entry
	b		kernel_enable_int
	b		kernel_disable_int

/*
朱收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收朱
早				 												 [ kernel Initialize ]														   早
朱收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收朱
*/

kernel_init:

	msr		cpsr_c, #0x40|0x12			/* IRQ 賅萄 滲唳  stack pointer 蟾晦		*/
	ldr			sp, =irq_stack
	msr		cpsr_c, #0x40|0x13			/* SVC 賅萄 滲唳  stack pointer 蟾晦		*/
	ldr			sp, =svc_stack
	msr		cpsr_c, #0xc0|0x13			/* SVC 賅萄煎 醴割 霞殮								*/

	bl			main									/* main() 轎 											*/
	b			_ram_entry

/*
朱收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收朱
早				 										 [ SOFT Context Switching ]													   早
朱收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收朱
*/

kernel_soft_CS:									/* 模Щお錚橫 僥裟瞪 								*/

	stmfd	sp!, {lr}								/* 腎給嬴陞 PC高 蝶鷗縑 PUSH					*/
	stmfd	sp!, {r0 - r12, lr}					/* r0~r12, LR高 蝶鷗縑 PUSH						*/
	mrs		r0, cpsr
	stmfd	sp!, {r0}								/* CPSR高 蝶鷗縑 PUSH								*/

	ldr			r0, =curPCB
	ldr			r0, [r0]
	str			sp, [r0]								/* ⑷營 PCB陛 陛葬酈朝 ん檣攪縑 sp 盪濰	*/

	bl			change_Prio						/* 辦摹牖嬪蒂 滲唳и棻								*/
	bl			change_PCB						/* PCB蒂 滲唳и棻 									*/

	ldr			r0, =highPCB
	ldr			r0, [r0]
	ldr			sp, [r0]								/* 棻擠 PCB陛 陛葬酈朝 ん檣攪縑憮 SP煎萄	*/

	ldmfd 	sp!, {r0}								/* CPSR高 蝶鷗戲煎睡攪 POP						*/
	msr 		cpsr_cxsf, #0x00000013	/* SVC賅萄煎 瞪 		 							*/
	ldmfd	sp!, {r0 - r12, lr, pc}			/* r0~r12, LR, PC高 蝶鷗縑憮 POP				*/

/*
朱收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收朱
早				 										 [ HARD Context Switching ]													   早
朱收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收朱
*/

kernel_hard_CS:									/* ж萄錚橫 僥裟瞪 								*/

	add		sp,sp,#20							/* SVS賅萄 SP蒂 犒掘и棻 							*/

	ldr			r0,=curPCB
	ldr			r0, [r0]
	str			sp, [r0]								/* ⑷營 PCB陛 陛葬酈朝 ん檣攪縑 sp 盪濰	*/

	bl			change_Prio						/* 辦摹牖嬪蒂 滲唳и棻								*/
	bl			change_PCB						/* PCB蒂 滲唳и棻 									*/

	ldr			r0, =highPCB
	ldr			r0, [r0]
	ldr			sp, [r0]								/* 棻擠 PCB陛 陛葬酈朝 ん檣攪縑憮 SP煎萄	*/

	ldmfd 	sp!, {r0}								/* CPSR高 蝶鷗戲煎睡攪 POP						*/
	msr		cpsr_cxsf,#0x00000013		/* SVC賅萄煎 瞪 		 							*/
	ldmfd	sp!, {r0 - r12, lr, pc}			/* r0~r12, LR, PC高 蝶鷗縑憮 POP				*/

/*
朱收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收朱
早														 [ kernel tick handler]															   早
朱收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收朱
*/

kernel_tick:										/* 顫歜 す с菟楝 										*/

	stmfd	sp!, {r0 - r3}						/* r0~r3高 蝶鷗縑 PUSH								*/

	mov		r2, sp
	add		sp, sp, #16						/* IRQ蝶鷗檜 餌辨й 詭賅葬 4奢除 綠遺 		*/
	sub		r3, lr, #4							/* IRQ賅萄煎睡攪 犒敝й 輿模 r3縑 盪濰 		*/
	

	msr		cpsr_cxsf, #0x00000093	/* SVC賅萄煎 瞪 									*/
	stmfd	sp!, {r3}								/* 腎給嬴陞 PC高 蝶鷗縑 PUSH					*/
	stmfd	sp!, {r4 - r12, lr}					/* r0~r12, LR高 蝶鷗縑 PUSH						*/
	mov		r4, r2
	ldmfd	r4!, {r0 - r3}						/* IRQ蝶鷗戲煎睡攪 r0~r3 POP	 				*/
	stmfd	sp!, {r0 - r3}						/* SVC蝶鷗縑 r0~r3 PUSH							*/

	mrs		r0, cpsr
	stmfd	sp!, {r0}								/* CPSR高 蝶鷗縑 PUSH								*/	

	bl			irqHandler							/* timer 蟾晦 											*/	
	bl			tick									/* PCB -> time 高 1噶馬模 							*/
	bl			ISR									/* kernel_hard_CS 轎л熱 						*/

	ldmfd	sp!, {r0 - r3}
	stmfd	sp!, {r0 - r3}

	ldmfd 	sp!, {r0}								/* CPSR高 蝶鷗戲煎睡攪 POP						*/
	msr		cpsr_cxsf, #0x00000013	/* SVC賅萄煎 瞪 		 							*/
	ldmfd	sp!, {r0 - r12, lr, pc}			/* r0~r12, LR, PC高 蝶鷗縑憮 POP				*/

/*
朱收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收朱
早				 												 [ kernel_entry ]															   早
朱收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收朱
*/

kernel_entry:										/* 醴割 睡た 囀萄 						 				*/

	ldr			r0, =highPCB
	ldr			r0, [r0]
	ldr			sp, [r0]								/* 棻擠 PCB陛 陛葬酈朝 ん檣攪縑憮 SP煎萄	*/

	ldmfd	sp!, {r0}
	msr		cpsr_cxsf, r0						/* CPSR 蟾晦 = SVC 賅萄 						*/

	bl			os_timer_init						/* 顫檜該 蟾晦 										*/
	bl			os_timer_start					/* 顫檜該 衛濛 											*/

	ldmfd	sp!, {r0 - r12, lr, pc}

/*
朱收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收朱
早				 											 [ Enable Interrupt ]															   早
朱收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收朱
*/

kernel_enable_int:								/* 檣攪毀お 側瘓 囀萄 							*/

	mrs		r1, cpsr
	bic		r1, r1, #0x80						/* BIC 翱骯戲煎 檣攪毀お 側 					*/
	msr		cpsr, r1
	mov		pc, lr

/*
朱收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收朱
早				 											 [ Disable Interrupt ]														   早
朱收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收朱
*/

kernel_disable_int:								/* 檣攪毀お 綠側瘓 囀萄 							*/

	mrs		r1, cpsr
	orr 		r1, r1, #0x80						/* ORR 翱骯戲煎 檣攪毀お 綠側 				*/
	msr 		cpsr, r1
	mov 		pc, lr

